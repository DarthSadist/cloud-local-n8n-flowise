# Автоматическая установка n8n, Flowise, Qdrant и других сервисов

Этот проект представляет собой набор скриптов для автоматизированной установки и настройки стека сервисов для работы с AI и автоматизацией рабочих процессов. Все сервисы развертываются в Docker-контейнерах и доступны через безопасные HTTPS-соединения благодаря Caddy.

## Включенные сервисы

- **n8n** - платформа автоматизации рабочих процессов с низкокодовым интерфейсом
  - Настроена для использования PostgreSQL для постоянного хранения данных
  - Включает Redis для очередей и кеширования
- **Flowise** - интерфейс для создания LLM-приложений и чат-цепочек
- **Qdrant** - векторная база данных для хранения и поиска эмбеддингов
  - Защищен API-ключом для безопасного доступа
- **Crawl4AI** - веб-сервис для сбора данных и их обработки
- **PostgreSQL** - реляционная база данных с расширением pgvector
- **Adminer** - веб-интерфейс для управления базами данных
- **Caddy** - веб-сервер с автоматическим получением SSL-сертификатов
- **Watchtower** - сервис для автоматического обновления Docker-контейнеров
- **Netdata** - система мониторинга в реальном времени

## Подробное описание сервисов

### n8n
[n8n](https://n8n.io/docs/) - это мощная платформа автоматизации рабочих процессов с открытым исходным кодом, позволяющая соединять различные сервисы и API без написания кода:
- Низкокодовый визуальный редактор для создания рабочих процессов (workflow)
- Поддержка более 300+ интеграций с популярными сервисами и API
- Возможность создания собственных узлов и расширений с помощью JavaScript/TypeScript
- Исполнение рабочих процессов по расписанию, webhook или триггерам
- Возможность запуска как в облаке, так и локально
- В этой установке настроена работа с PostgreSQL для надежного хранения данных
- Интеграция с Redis для улучшения производительности, кеширования и обработки очередей
- Предусмотрена система пользователей с разграничением доступа к workspaces
- [Примеры рабочих процессов](https://n8n.io/workflows/)

### Flowise
[Flowise](https://github.com/FlowiseAI/Flowise) - это инструмент с открытым исходным кодом для создания настраиваемых AI-приложений и цепочек взаимодействия с LLM:
- Визуальный конструктор для создания чат-ботов и LLM-приложений без написания кода
- Поддержка различных моделей и провайдеров LLM (OpenAI, Anthropic, Llama, Mistral и др.)
- Интеграция с векторными базами данных, включая Qdrant, Pinecone, Weaviate
- Возможность создания и обучения собственных AI-агентов с памятью и инструментами
- Предоставляет RESTful API и WebSocket для интеграции созданных решений
- Управление контекстом и памятью для долгих диалогов
- Полная совместимость с LangChain.js и интерфейсом Chains 
- Поддержка встраивания в существующие веб-приложения через iframe
- [Документация по API](https://docs.flowiseai.com/)

### Qdrant
[Qdrant](https://qdrant.tech/documentation/) - это современная векторная база данных, специально разработанная для систем поиска по семантическому сходству:
- Высокопроизводительное хранение и поиск векторных эмбеддингов с низкой латентностью
- Поддержка фильтрации при векторном поиске для сложных условий выборки
- Масштабируемость и производительность для больших наборов данных (миллиарды векторов)
- Возможность горизонтального масштабирования через кластеры
- Защита API с помощью ключей для безопасного доступа
- Поддержка различных метрик расстояния: Евклидово, Косинусное, Dot-product
- Управление метаданными и полями для каждого вектора
- Возможность обновления, удаления и добавления векторов без перестроения индексов
- Интегрируется с Flowise и n8n для построения векторных хранилищ знаний
- [Учебные материалы и примеры](https://qdrant.tech/documentation/tutorials/)

### PostgreSQL с pgvector
[PostgreSQL](https://www.postgresql.org/docs/) с расширением [pgvector](https://github.com/pgvector/pgvector) - это мощная объектно-реляционная система управления базами данных с поддержкой векторных вычислений:
- Надежное хранение структурированных данных для n8n и других сервисов
- Расширение pgvector для работы с векторными эмбеддингами и семантическим поиском
- Поддержка транзакций, триггеров, представлений и хранимых процедур
- Богатая экосистема инструментов и расширений
- Поддержка индексов HNSW для быстрого поиска ближайших соседей
- Возможность комбинирования традиционных SQL-запросов с векторным поиском
- Масштабируемость и высокая производительность
- Совместимость с многочисленными инструментами для анализа и визуализации данных
- [Документация pgvector](https://github.com/pgvector/pgvector/blob/master/README.md)

### Crawl4AI
Crawl4AI - это веб-сервис для сбора данных из различных источников для AI-приложений:
- API для получения и обработки данных из веб-источников
- Защита доступа с помощью JWT-аутентификации
- Возможность расширения и настройки для конкретных задач сбора данных
- Управление очередями заданий для масштабного скрапинга
- Интегрируется с n8n и Flowise для автоматизированного сбора и обработки данных
- Возможность планирования задач по расписанию
- Соблюдение рекомендаций robots.txt для этичного скрапинга

### Adminer
[Adminer](https://www.adminer.org/) - легковесный инструмент для управления базами данных через веб-интерфейс:
- Позволяет управлять базой данных PostgreSQL через браузер
- Поддержка выполнения SQL-запросов и просмотра результатов
- Возможность экспорта и импорта данных
- Просмотр и редактирование структуры таблиц
- Управление индексами, внешними ключами и пользователями
- Поддержка множества типов баз данных (MySQL, PostgreSQL, SQLite, MS SQL, Oracle)
- Компактный размер и высокая производительность
- [Документация и руководства](https://www.adminer.org/en/doc/)

### Caddy
[Caddy](https://caddyserver.com/docs/) - это современный веб-сервер с автоматическим HTTPS:
- Автоматическое получение и обновление SSL-сертификатов от Let's Encrypt
- Выступает в роли обратного прокси для всех сервисов в стеке
- Простая и понятная конфигурация без сложных директив
- Встроенная поддержка HTTP/2 и HTTP/3
- Высокая производительность и безопасность по умолчанию
- Поддержка статических файлов и динамического контента
- Встроенные средства кеширования и сжатия
- [Руководство по Caddyfile](https://caddyserver.com/docs/caddyfile-tutorial)

### Watchtower
[Watchtower](https://containrrr.dev/watchtower/) - это сервис для автоматического обновления Docker-контейнеров:
- Отслеживает обновления образов Docker для всех установленных сервисов
- Автоматически обновляет контейнеры до последних версий с минимальным простоем
- Настраиваемый график обновлений (по умолчанию — ежедневно в 4:00)
- Уведомления о результатах обновлений через различные каналы
- Поддержка Docker Swarm и Kubernetes
- Гибкое управление через метки контейнеров
- Минимальное потребление ресурсов в режиме ожидания
- [Примеры конфигурации](https://containrrr.dev/watchtower/examples/)

### Netdata
[Netdata](https://learn.netdata.cloud/docs/) - система мониторинга производительности в реальном времени:
- Отслеживает тысячи метрик системы, приложений и контейнеров с секундной гранулярностью
- Предоставляет интерактивные дашборды с графиками производительности в реальном времени
- Автоматически определяет аномалии и потенциальные проблемы
- Имеет крайне низкие накладные расходы на мониторинг (менее 1% CPU)
- Не требует сложной настройки — работает "из коробки"
- Отслеживает состояние Docker-контейнеров и их ресурсов
- Поддерживает предупреждения и уведомления о проблемах
- Возможность экспорта метрик в другие системы мониторинга
- [Руководство по мониторингу Docker](https://learn.netdata.cloud/docs/agent/packaging/docker)

## Системные требования

- Ubuntu 22.04 LTS или другой совместимый дистрибутив Linux
- Минимум 2 ГБ RAM (рекомендуется 4+ ГБ)
- Минимум 20 ГБ дискового пространства
- Настроенное доменное имя, указывающее на IP вашего сервера
- Открытые порты 80 и 443

## Быстрая установка

1. Клонируйте репозиторий:
   ```bash
   git clone https://github.com/DarthSadist/cloud-local-n8n-flowise.git
   cd cloud-local-n8n-flowise
   ```

2. Запустите установочный скрипт:
   ```bash
   chmod +x setup.sh
   ./setup.sh
   ```

3. Следуйте инструкциям в терминале:
   - Введите ваше доменное имя
   - Укажите email для Let's Encrypt и авторизации в n8n
   - Подтвердите часовой пояс

## Доступ к сервисам

После успешной установки сервисы будут доступны по следующим адресам:

- **n8n**: https://n8n.ваш-домен
- **Flowise**: https://flowise.ваш-домен
- **Adminer**: https://adminer.ваш-домен
- **Qdrant**: https://qdrant.ваш-домен
- **Crawl4AI**: https://crawl4ai.ваш-домен
- **Netdata**: https://netdata.ваш-домен

## Учетные данные

Все учетные данные генерируются автоматически и сохраняются в файле `/opt/.env`. В конце установки вам будут показаны основные логины и пароли.

### Для n8n:
- **Логин**: email, указанный при установке
- **Пароль**: автоматически сгенерированный (см. в `/opt/.env`)

### Для Flowise:
- **Логин**: admin
- **Пароль**: автоматически сгенерированный (см. в `/opt/.env`)

### Для PostgreSQL (через Adminer):
- **Сервер**: postgres
- **Имя пользователя**: n8n
- **Пароль**: автоматически сгенерированный (см. в `/opt/.env`)
- **База данных**: n8n

### Для Qdrant:
- **API-ключ**: автоматически сгенерированный (см. в `/opt/.env`)

### Для Crawl4AI:
- **JWT-секрет**: автоматически сгенерированный (см. в `/opt/.env`)

## Управление сервисами

### Проверка статуса контейнеров
```bash
sudo docker ps
```

### Перезапуск сервисов
```bash
# Перезапуск n8n и связанных сервисов (PostgreSQL, Redis, Caddy)
sudo docker compose -f /opt/n8n-docker-compose.yaml --env-file /opt/.env restart

# Перезапуск Flowise
sudo docker compose -f /opt/flowise-docker-compose.yaml --env-file /opt/.env restart

# Перезапуск Qdrant
sudo docker compose -f /opt/qdrant-docker-compose.yaml --env-file /opt/.env restart

# Перезапуск Crawl4AI
sudo docker compose -f /opt/crawl4ai-docker-compose.yaml --env-file /opt/.env restart

# Перезапуск Watchtower
sudo docker compose -f /opt/watchtower-docker-compose.yaml restart

# Перезапуск Netdata
sudo docker compose -f /opt/netdata-docker-compose.yaml restart
```

### Остановка сервисов
```bash
sudo docker compose -f /opt/n8n-docker-compose.yaml --env-file /opt/.env down
sudo docker compose -f /opt/flowise-docker-compose.yaml --env-file /opt/.env down
sudo docker compose -f /opt/qdrant-docker-compose.yaml --env-file /opt/.env down
sudo docker compose -f /opt/crawl4ai-docker-compose.yaml --env-file /opt/.env down
sudo docker compose -f /opt/watchtower-docker-compose.yaml down
sudo docker compose -f /opt/netdata-docker-compose.yaml down
```

### Просмотр логов
```bash
# Просмотр логов n8n
sudo docker logs n8n

# Просмотр логов Flowise
sudo docker logs flowise

# Просмотр логов Qdrant
sudo docker logs qdrant

# Просмотр логов Caddy
sudo docker logs caddy
```

## Резервное копирование

Для создания резервных копий всех данных:

1. Запустите скрипт резервного копирования:
   ```bash
   sudo ./setup-files/10-backup-data.sh
   ```

2. Резервные копии будут сохранены в директории `/opt/backups/` в виде `.tar.gz` архивов с датой и временем.

3. Рекомендуется регулярно копировать эти резервные копии в надежное хранилище.

## Восстановление из резервных копий

1. Остановите сервис, данные которого нужно восстановить, например:
   ```bash
   sudo docker compose -f /opt/n8n-docker-compose.yaml stop n8n
   ```

2. Используйте временный контейнер для восстановления данных:
   ```bash
   sudo docker run --rm \
       -v n8n_data:/restore_dest \
       -v /opt/backups:/backups \
       alpine \
       tar xzf /backups/n8n_data_YYYYMMDD_HHMMSS.tar.gz -C /restore_dest
   ```

3. Перезапустите сервис:
   ```bash
   sudo docker compose -f /opt/n8n-docker-compose.yaml start n8n
   ```

## Структура проекта

- `setup.sh` - основной скрипт установки
- `setup-files/` - скрипты для отдельных этапов установки:
  - `01-update-system.sh` - обновление системы
  - `02-install-docker.sh` - установка Docker
  - `03-create-volumes.sh` - создание Docker-томов
  - `03b-setup-directories.sh` - настройка директорий
  - `04-generate-secrets.sh` - генерация секретных ключей
  - `05-create-templates.sh` - создание файлов конфигурации
  - `06-setup-firewall.sh` - настройка брандмауэра
  - `07-start-services.sh` - запуск сервисов
  - `check_disk_space.sh` - проверка свободного места
  - `10-backup-data.sh` - создание резервных копий
- Файлы шаблонов `*.template` для создания конфигураций Docker Compose и Caddy

## Безопасность

- Все сервисы доступны только по HTTPS с автоматически обновляемыми сертификатами Let's Encrypt
- Для всех сервисов генерируются случайные надежные пароли
- API Qdrant защищен API-ключом
- API Crawl4AI защищен JWT-аутентификацией
- Все тома Docker настроены для сохранения данных между перезапусками

## Устранение неполадок

### Проблемы с Caddy
Если Caddy не запускается или не удается получить сертификаты:
```bash
sudo docker logs caddy
```

### Диагностика всего стека
Запустите диагностический скрипт:
```bash
./setup-diag.sh
```

### Очистка неиспользуемых ресурсов Docker
Если заканчивается место на диске:
```bash
sudo docker system prune -a
```

## Лицензия

Данный проект распространяется под лицензией MIT.

## Контакты

При возникновении вопросов или проблем, пожалуйста, создайте issue в этом репозитории.
