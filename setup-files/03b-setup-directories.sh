#!/bin/bash

set -euo pipefail

echo "üîß –ù–∞—á–∏–Ω–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π..."

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è n8n
if ! id "n8n" &>/dev/null; then
  echo "üë§ –°–æ–∑–¥–∞—ë–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è n8n..."
  sudo adduser --disabled-password --gecos "" n8n
  
  # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–ª—É—á–∞–π–Ω–æ–≥–æ –ø–∞—Ä–æ–ª—è
  N8N_PASSWORD=$(openssl rand -base64 16)
  echo "n8n:${N8N_PASSWORD}" | sudo chpasswd
  echo "üîë –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å n8n —Å–æ–∑–¥–∞–Ω, –ø–∞—Ä–æ–ª—å: ${N8N_PASSWORD}"

  sudo usermod -aG docker n8n || echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å n8n –≤ –≥—Ä—É–ø–ø—É docker"
else
  echo "‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å n8n —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç."
  read -rp "üîÑ –°–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é n8n? (y/n): " reset_pass
  if [[ "$reset_pass" == "y" ]]; then
    N8N_PASSWORD=$(openssl rand -base64 16)
    echo "n8n:${N8N_PASSWORD}" | sudo chpasswd
    echo "üîë –ü–∞—Ä–æ–ª—å –¥–ª—è n8n —Å–±—Ä–æ—à–µ–Ω –Ω–∞: ${N8N_PASSWORD}"
  fi
fi

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏
echo "üìÇ –°–æ–∑–¥–∞—ë–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é /opt/n8n..."
sudo mkdir -p /opt/n8n
sudo chown -R n8n:n8n /opt/n8n
echo "‚úÖ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞."

# –°–æ–∑–¥–∞–Ω–∏–µ Docker volume-–æ–≤ —á–µ—Ä–µ–∑ —Ü–∏–∫–ª
volumes=("n8n_data" "caddy_data" "postgres_data" "redis_data" "n8n_user_files" "flowise_data" "qdrant_data")

for volume in "${volumes[@]}"; do
  echo "üê≥ –°–æ–∑–¥–∞—ë–º Docker volume: ${volume}..."
  sudo docker volume create "${volume}" >/dev/null || { echo "‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è Docker volume: ${volume}"; exit 1; }
done

echo "üéâ –í—Å–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏ Docker volume —É—Å–ø–µ—à–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã!"
exit 0
