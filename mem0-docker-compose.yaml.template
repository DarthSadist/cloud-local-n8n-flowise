version: '3.8'
services:
  mem0:
    image: node:18-alpine
    container_name: mem0
    restart: unless-stopped
    working_dir: /app
    command: >
      sh -c "apk add --no-cache git python3 py3-pip &&
             git clone https://github.com/DarthSadist/mem0.git . &&
             if [ -f requirements.txt ]; then
               pip install -r requirements.txt;
             else
               pip install mem0ai;
             fi &&
             npm install &&
             npm start || python -m mem0.server"
    environment:
      - MEM0_API_KEY=${MEM0_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
      - QDRANT_URL=http://qdrant:6333
      - QDRANT_API_KEY=${QDRANT_API_KEY}
      - MEM0_HOST=0.0.0.0
      - MEM0_PORT=3456
    expose:
      - "3456"
    volumes:
      - mem0_data:/app/data
    networks:
      - app-network
    depends_on:
      - postgres
      - qdrant

networks:
  app-network:
    external: true

volumes:
  mem0_data:
    external: true
